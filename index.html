<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Rekap Kebakaran</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
body{
  font-family:Segoe UI,Arial;
  background:#0f1115;
  color:#eaeaea;
  margin:20px;
}
h1{color:#ff6b6b}
select{
  padding:8px 12px;
  border-radius:8px;
  background:#161a24;
  color:#fff;
  border:1px solid #2a2e3b;
  margin-bottom:14px;
}
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:14px;
  margin-bottom:20px;
}
.card{
  background:#161a24;
  border-radius:14px;
  padding:16px;
}
.card h2{margin:0;font-size:14px;color:#aaa}
.card .count{font-size:40px;font-weight:800}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  border:1px solid #2a2e3b;
  padding:6px;
}
th{
  background:#1c2130;
  color:#ffb3b3;
}
tr:nth-child(even){background:#141824}
</style>
</head>

<body>

<h1>ðŸ”¥ Dashboard Rekap Kebakaran</h1>

<select id="bulan"></select>

<div class="dashboard">
  <div class="card"><h2>Jakarta Barat</h2><div class="count" id="jb">0</div></div>
  <div class="card"><h2>Jakarta Pusat</h2><div class="count" id="jp">0</div></div>
  <div class="card"><h2>Jakarta Selatan</h2><div class="count" id="js">0</div></div>
  <div class="card"><h2>Jakarta Timur</h2><div class="count" id="jt">0</div></div>
  <div class="card"><h2>Jakarta Utara</h2><div class="count" id="ju">0</div></div>
  <div class="card"><h2>Kep. Seribu</h2><div class="count" id="ks">0</div></div>
  <div class="card"><h2>Total</h2><div class="count" id="total">0</div></div>
</div>

<table>
<thead>
<tr>
  <th>Tanggal</th>
  <th>Waktu</th>
  <th>Jenis</th>
  <th>Alamat</th>
  <th>Kelurahan</th>
  <th>Kecamatan</th>
  <th>Kota</th>
  <th>Objek</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
google.charts.load('current', {packages:['corechart']});
google.charts.setOnLoadCallback(init);

const SHEET_ID = "1PU8hf7BEu142XSi0QjCMDgPsD6KaSFET";
const bulanNama = [
  "Januari","Februari","Maret","April","Mei","Juni",
  "Juli","Agustus","September","Oktober","November","Desember"
];

const select = document.getElementById("bulan");
let sheetValid = [];

function init(){
  deteksiSheet(0);
}

function deteksiSheet(i){
  if(i >= bulanNama.length){
    if(sheetValid.length === 0){
      alert("Tidak ada sheet bulan yang terbaca");
      return;
    }
    sheetValid.forEach(b=>{
      const o=document.createElement("option");
      o.value=b; o.text=b;
      select.appendChild(o);
    });

    const bulanNow = bulanNama[new Date().getMonth()];
    select.value = sheetValid.includes(bulanNow) ? bulanNow : sheetValid[0];
    loadSheet(select.value);

    select.onchange = ()=>loadSheet(select.value);
    return;
  }

  const nama = bulanNama[i];
  const q = new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${nama}`
  );

  q.send(res=>{
    if(!res.isError() && res.getDataTable().getNumberOfRows() > 0){
      sheetValid.push(nama);
    }
    deteksiSheet(i+1);
  });
}

function loadSheet(nama){
  const q=new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${nama}`
  );
  q.send(res=>{
    if(res.isError()) return;
    render(res.getDataTable());
  });
}

function render(dt){
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  let count={
    "Jakarta Barat":0,
    "Jakarta Pusat":0,
    "Jakarta Selatan":0,
    "Jakarta Timur":0,
    "Jakarta Utara":0,
    "Kepulauan Seribu":0
  };
  let unik={};

  for(let i=0;i<dt.getNumberOfRows();i++){
    const jenis=(dt.getValue(i,2)||"").toLowerCase();
    if(!jenis.includes("kebakaran")) continue;

    const tgl=dt.getValue(i,0)||"";
    const alamat=dt.getValue(i,3)||"";
    const kota=dt.getValue(i,6)||"";
    const key=tgl+alamat+kota;
    if(unik[key]) continue;
    unik[key]=1;

    if(count[kota]!=null) count[kota]++;

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${tgl}</td>
        <td>${dt.getValue(i,1)||""}</td>
        <td>KEBAKARAN</td>
        <td>${alamat}</td>
        <td>${dt.getValue(i,4)||""}</td>
        <td>${dt.getValue(i,5)||""}</td>
        <td>${kota}</td>
        <td>${dt.getValue(i,7)||""}</td>
      </tr>
    `);
  }

  document.getElementById("jb").innerText=count["Jakarta Barat"];
  document.getElementById("jp").innerText=count["Jakarta Pusat"];
  document.getElementById("js").innerText=count["Jakarta Selatan"];
  document.getElementById("jt").innerText=count["Jakarta Timur"];
  document.getElementById("ju").innerText=count["Jakarta Utara"];
  document.getElementById("ks").innerText=count["Kepulauan Seribu"];
  document.getElementById("total").innerText=
    Object.values(count).reduce((a,b)=>a+b,0);
}
</script>

</body>
</html>
